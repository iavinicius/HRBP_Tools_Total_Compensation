<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Total Rewards | Vini HRBP</title>
    
    <!-- Bibliotecas Externas (Requer Internet) -->
    <!-- Tailwind CSS (Estilo) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js (Gráficos) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome (Ícones) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts (Tipografia) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- CSS Interno (Personalização) -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .toggle-checkbox:checked { right: 0; border-color: #4F46E5; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4F46E5; }
        
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .input-calc:focus { border-color: #6366f1; ring: 2px; --tw-ring-color: rgba(99, 102, 241, 0.1); }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #4F46E5; cursor: pointer; margin-top: -6px; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #e2e8f0; border-radius: 2px;
        }

        .scale-marker { position: absolute; bottom: 0; width: 1px; height: 5px; background-color: #cbd5e1; }
        .scale-label { position: absolute; bottom: -14px; transform: translateX(-50%); font-size: 8px; color: #94a3b8; font-weight: 500; }
        
        .cr-pointer {
            width: 0; height: 0; 
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 6px solid #334155;
            position: absolute; top: -3px; transform: translateX(-50%);
            transition: left 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 20;
        }

        /* Estilos da Tabela */
        .tr-header-section { background-color: #f1f5f9; color: #475569; font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; }
        .tr-total { border-top: 2px solid #e2e8f0; background-color: #f8fafc; }
    </style>
</head>
<body class="text-slate-600 h-screen flex flex-col overflow-hidden relative">

    <!-- Indicador de Salvamento -->
    <div id="saveIndicator" class="fixed top-4 right-4 z-50 bg-white/80 backdrop-blur border border-slate-200 shadow-sm px-3 py-1.5 rounded-full text-[10px] text-slate-400 flex items-center gap-2 opacity-0 transition-opacity pointer-events-none">
        <i class="fa-solid fa-floppy-disk text-emerald-500"></i> Salvo
    </div>

    <!-- Modal de Boas Vindas -->
    <div id="welcomeModal" class="absolute inset-0 z-50 bg-slate-50 flex items-center justify-center p-4 fade-in">
        <div class="max-w-3xl w-full bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
            <div class="p-10 text-center">
                <div class="inline-flex items-center justify-center w-14 h-14 rounded-full bg-indigo-50 text-indigo-600 mb-5 shadow-sm">
                    <i class="fa-solid fa-calculator text-2xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-slate-800 mb-2 tracking-tight">Calculadora Total Rewards</h1>
                <p class="text-slate-500">Selecione a região para iniciar a análise</p>
                
                <div class="grid grid-cols-2 gap-6 mt-10 max-w-lg mx-auto">
                    <button onclick="selectCountry('BR')" class="group flex flex-col items-center p-6 bg-slate-50 hover:bg-white border border-slate-200 hover:border-indigo-300 rounded-xl transition-all hover:shadow-md">
                        <img src="https://flagcdn.com/w160/br.png" alt="Brasil" class="h-12 mb-4 shadow-sm group-hover:scale-110 transition-transform">
                        <span class="font-bold text-slate-700 group-hover:text-indigo-700 text-lg">Brasil</span>
                        <span class="text-xs text-slate-400 mt-1 uppercase tracking-wide">Real (BRL)</span>
                    </button>
                    <button onclick="selectCountry('ARG')" class="group flex flex-col items-center p-6 bg-slate-50 hover:bg-white border border-slate-200 hover:border-sky-300 rounded-xl transition-all hover:shadow-md">
                        <img src="https://flagcdn.com/w160/ar.png" alt="Argentina" class="h-12 mb-4 shadow-sm group-hover:scale-110 transition-transform">
                        <span class="font-bold text-slate-700 group-hover:text-sky-700 text-lg">Argentina</span>
                        <span class="text-xs text-slate-400 mt-1 uppercase tracking-wide">Peso (ARS)</span>
                    </button>
                </div>
            </div>
            <div class="bg-slate-50 p-4 text-center border-t border-slate-100">
                <p class="text-[10px] text-slate-400 uppercase tracking-widest">Desenvolvido por Vinicius Carlos</p>
            </div>
        </div>
    </div>

    <!-- Modal de Conceitos -->
    <div id="conceptsModal" class="hidden absolute inset-0 z-50 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-xl shadow-xl max-w-3xl w-full h-3/4 flex flex-col">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 rounded-t-xl">
                <h3 class="text-lg font-bold text-slate-700 flex items-center gap-2">
                    <i class="fa-solid fa-book-open text-indigo-500"></i> <span id="conceptsTitle">Conceitos & Fórmulas</span>
                </h3>
                <button onclick="toggleConcepts(false)" class="text-gray-400 hover:text-slate-700 transition w-8 h-8 rounded-full hover:bg-gray-200 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-8 overflow-y-auto prose prose-slate max-w-none text-sm flex-1">
                <div id="conceptsContent"></div>
            </div>
            <div class="p-4 border-t border-gray-100 bg-gray-50 rounded-b-xl text-center">
                <p class="text-[10px] text-slate-400 uppercase tracking-widest">Desenvolvido por Vinicius Carlos</p>
            </div>
        </div>
    </div>

    <!-- APP CONTAINER -->
    <div id="appContainer" class="flex flex-col md:flex-row h-full opacity-0 transition-opacity duration-700">
        
        <!-- SIDEBAR (Esquerda) -->
        <aside class="w-full md:w-[360px] bg-white border-r border-slate-200 flex flex-col h-full shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-20">
            <div class="p-6 border-b border-slate-100 sticky top-0 bg-white z-10">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h1 class="text-lg font-bold text-slate-800 leading-tight">Total Compensation</h1>
                        <p class="text-[10px] text-slate-400 uppercase tracking-widest font-medium">HR TOOLS</p>
                    </div>
                    <div class="text-right">
                        <img id="flagDisplay" src="https://flagcdn.com/w40/br.png" class="h-6 rounded shadow-sm">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button onclick="resetData()" class="text-xs font-bold bg-slate-50 hover:bg-slate-100 text-slate-600 py-2 rounded-lg border border-slate-200 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-eraser"></i> <span data-i18n="clear">Limpar</span>
                    </button>
                    <button onclick="toggleAdvanced()" class="text-xs font-bold bg-amber-50 hover:bg-amber-100 text-amber-700 py-2 rounded-lg border border-amber-200 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-sliders"></i> <span data-i18n="advanced">Avançado</span>
                    </button>
                </div>

                <div class="flex items-center justify-between bg-slate-50 p-2.5 rounded-lg border border-slate-100 mb-3">
                    <span class="text-xs font-bold text-slate-500 uppercase tracking-wide" data-i18n="compare_mode">Modo Comparativo</span>
                    <div class="relative inline-block w-10 align-middle select-none">
                        <input type="checkbox" id="compareToggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 left-0 transition-all duration-300"/>
                        <label for="compareToggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer"></label>
                    </div>
                </div>

                <button onclick="toggleConcepts(true)" class="w-full text-[10px] font-bold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 py-1.5 rounded-lg transition flex items-center justify-center gap-2 mb-4">
                    <i class="fa-solid fa-book-open"></i> <span data-i18n="concepts_btn">Ver Conceitos & Fórmulas</span>
                </button>

                <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold text-slate-500 uppercase" data-i18n="proj_months">Projeção (Meses)</span>
                        <span id="projMonthsDisplay" class="text-xs font-bold text-indigo-600 bg-white px-2 py-0.5 rounded border border-indigo-100">12 Meses</span>
                    </div>
                    <input type="range" id="projMonths" min="1" max="12" value="12" class="w-full">
                    <div class="flex justify-between text-[8px] text-slate-400 mt-1">
                        <span>1m</span>
                        <span>6m</span>
                        <span>12m</span>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-6 space-y-8 custom-scroll pb-24 relative">
                
                <!-- PAINEL AVANÇADO -->
                <div id="advancedPanel" class="hidden absolute inset-0 bg-white z-20 p-6 space-y-5 animate-fade-in">
                    <div class="flex justify-between items-center border-b border-slate-100 pb-3">
                        <h3 class="text-xs font-bold text-amber-600 uppercase" data-i18n="advanced_config">Configurações Avançadas</h3>
                        <button onclick="toggleAdvanced()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-lg"></i></button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="col-span-2">
                                <label class="block text-[10px] font-bold text-slate-500 mb-1" id="lblCharges" data-i18n="charges">Encargos (%)</label>
                                <input type="number" id="rateCharges" class="input-calc w-full text-xs border border-slate-300 rounded p-2 focus:border-amber-400 outline-none" value="28.8">
                                <p class="text-[9px] text-slate-400 mt-1 italic" id="lblChargesHint">Estimativa Patronal + SAT</p>
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 mb-1" data-i18n="fund">Fundo/FGTS (%)</label>
                                <input type="number" id="rateFund" class="input-calc w-full text-xs border border-slate-300 rounded p-2 focus:border-amber-400 outline-none" value="8.0">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 mb-1" id="lblVacDays" data-i18n="vac_days">Dias Férias</label>
                                <input type="number" id="vacationDays" class="input-calc w-full text-xs border border-slate-300 rounded p-2 bg-slate-50" readonly value="30">
                            </div>
                        </div>

                        <div class="border-t border-dashed border-slate-200 pt-3">
                            <p class="text-[10px] font-bold text-slate-400 uppercase mb-2" data-i18n="fixed_costs">Custos Fixos (Mensal)</p>
                            <div class="grid grid-cols-2 gap-3">
                                <input type="text" id="advHealth" class="fmt-curr input-calc w-full text-xs border border-slate-300 rounded p-2" placeholder="Saúde">
                                <input type="text" id="advDental" class="fmt-curr input-calc w-full text-xs border border-slate-300 rounded p-2" placeholder="Odonto">
                                <input type="text" id="advLife" class="fmt-curr input-calc col-span-2 w-full text-xs border border-slate-300 rounded p-2" placeholder="Vida / Previdência">
                            </div>
                        </div>

                        <div id="inflationPanel" class="hidden border-t border-dashed border-slate-200 pt-3">
                            <label class="block text-[10px] font-bold text-orange-600 mb-1" data-i18n="inflation">IPC Mensal Estimado (%)</label>
                            <input type="number" id="inflationRate" class="input-calc w-full text-xs border border-orange-200 rounded p-2 text-orange-800 bg-orange-50" value="5.0" step="0.1">
                        </div>
                    </div>
                </div>

                <!-- CENÁRIO A -->
                <div id="scenarioA" class="space-y-5">
                    <div class="flex items-center justify-between border-b border-slate-100 pb-2">
                        <h2 class="text-xs font-bold text-indigo-700 uppercase tracking-wide flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-indigo-600"></span> <span data-i18n="scenario_a">Cenário A (Atual)</span>
                        </h2>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-[11px] font-semibold text-slate-500 mb-1 uppercase tracking-wide" data-i18n="salary">Salário Base</label>
                            <div class="relative">
                                <input type="text" id="salaryA" class="fmt-curr input-calc w-full px-3 py-2 text-sm border border-slate-300 rounded-lg outline-none transition-all text-slate-700 font-medium placeholder-slate-300" placeholder="0,00">
                            </div>
                            <div class="flex justify-end gap-2 mt-1">
                                <div class="text-[9px] text-slate-400 bg-slate-100 px-1.5 rounded" id="taxModeBadgeA">Taxa Fixa</div>
                                <div class="text-[10px] text-green-600 font-bold" id="badgeNetA">Líquido: --</div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-[11px] font-semibold text-slate-500 mb-1 uppercase tracking-wide">Midpoint</label>
                            <div class="relative">
                                <input type="text" id="midpointA" class="fmt-curr input-calc w-full px-3 py-2 text-sm border border-slate-300 rounded-lg outline-none transition-all text-slate-700 placeholder-slate-300" placeholder="0,00">
                            </div>
                        </div>

                        <div>
                            <label class="block text-[11px] font-semibold text-slate-500 mb-1 uppercase tracking-wide" data-i18n="bonus_target">Bônus Target (Salários)</label>
                            <div class="flex gap-2">
                                <div class="w-24 relative">
                                    <input type="number" id="bonusMultiA" placeholder="0.0" step="0.1" class="input-calc w-full pl-3 pr-6 py-2 text-sm border border-slate-300 rounded-lg outline-none transition-all text-center font-bold text-indigo-600 bg-indigo-50/30">
                                    <span class="absolute right-2 top-2.5 text-[10px] text-slate-400 font-bold">x</span>
                                </div>
                                <div class="flex-1 relative">
                                    <input type="text" id="bonusValA" readonly class="w-full px-3 py-2 text-sm border border-slate-200 bg-slate-50 rounded-lg text-slate-500 cursor-default font-medium" placeholder="Calculado">
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-[11px] font-semibold text-slate-500 mb-1 uppercase tracking-wide lbl-food" data-i18n="benefits">Benefícios (VA/VR)</label>
                            <div class="relative">
                                <input type="text" id="flexBenA" class="fmt-curr input-calc w-full px-3 py-2 text-sm border border-slate-300 rounded-lg outline-none transition-all text-slate-700 placeholder-slate-300" placeholder="0,00">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CENÁRIO B -->
                <div id="scenarioB" class="hidden space-y-5 pt-6 border-t border-dashed border-slate-300">
                    <div class="flex items-center justify-between border-b border-slate-100 pb-2">
                        <h2 class="text-xs font-bold text-emerald-700 uppercase tracking-wide flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-emerald-600"></span> <span data-i18n="scenario_b">Cenário B (Proposto)</span>
                        </h2>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-[11px] font-semibold text-slate-500 mb-1 uppercase tracking-wide" data-i18n="salary">Salário Base</label>
                            <div class="relative">
                                <input type="text" id="salaryB" class="fmt-curr input-calc w-full px-3 py-2 text-sm border border-slate-300 rounded-lg outline-none transition-all text-slate-700 font-medium placeholder-slate-300" placeholder="0,00">
                            </div>
                            <div class="text-[10px] text-green-600 font-bold text-right mt-1" id="badgeNetB">Líquido: --</div>
                        </div>
                        
                        <div>
                            <label class="block text-[11px] font-semibold text-slate-500 mb-1 uppercase tracking-wide">Midpoint</label>
                            <div class="relative">
                                <input type="text" id="midpointB" class="fmt-curr input-calc w-full px-3 py-2 text-sm border border-slate-300 rounded-lg outline-none transition-all text-slate-700 placeholder-slate-300" placeholder="0,00">
                            </div>
                        </div>

                        <div>
                            <label class="block text-[11px] font-semibold text-slate-500 mb-1 uppercase tracking-wide" data-i18n="bonus_target">Bônus Target (Salários)</label>
                            <div class="flex gap-2">
                                <div class="w-24 relative">
                                    <input type="number" id="bonusMultiB" placeholder="0.0" step="0.1" class="input-calc w-full pl-3 pr-6 py-2 text-sm border border-slate-300 rounded-lg outline-none transition-all text-center font-bold text-emerald-600 bg-emerald-50/30">
                                </div>
                                <div class="flex-1 relative">
                                    <input type="text" id="bonusValB" readonly class="w-full px-3 py-2 text-sm border border-slate-200 bg-slate-50 rounded-lg text-slate-500 cursor-default font-medium" placeholder="Calculado">
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-[11px] font-semibold text-slate-500 mb-1 uppercase tracking-wide lbl-food" data-i18n="benefits">Benefícios (VA/VR)</label>
                            <div class="relative">
                                <input type="text" id="flexBenB" class="fmt-curr input-calc w-full px-3 py-2 text-sm border border-slate-300 rounded-lg outline-none transition-all text-slate-700 placeholder-slate-300" placeholder="0,00">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- DASHBOARD (Direita) -->
        <main class="flex-1 flex flex-col h-full bg-[#F8FAFC] relative overflow-hidden">
            
            <div class="flex-1 overflow-y-auto p-6 md:p-10 space-y-8 pb-20">
                
                <!-- DASHBOARD PADRÃO -->
                <div id="standardView" class="animate-fade-in space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Card Custo Total -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 relative overflow-hidden group">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-indigo-50 rounded-bl-full -mr-6 -mt-6 transition-transform group-hover:scale-110"></div>
                            <div class="relative z-10">
                                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider lbl-annual-cost" data-i18n="total_cost_label">Custo Total (12m)</p>
                                <h2 class="text-4xl font-bold text-slate-800 mt-2 tracking-tight" id="kpiTotalA">0</h2>
                                <div class="mt-4 pt-3 border-t border-slate-50 flex items-center justify-between">
                                    <div>
                                        <p class="text-xs text-slate-500 font-medium" data-i18n="monthly_avg">Média Mensal</p>
                                        <p class="text-sm font-bold text-slate-700" id="kpiMonthlyA">0</p>
                                    </div>
                                    <span class="text-[9px] text-slate-400 bg-slate-50 px-2 py-1 rounded" data-i18n="fixed_only">(Apenas Fixo)</span>
                                </div>
                            </div>
                        </div>

                        <!-- Card Análise -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col justify-between">
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 flex items-center gap-2">
                                    <i class="fa-solid fa-bolt text-amber-400"></i> <span data-i18n="impact_analysis">Análise de Impacto</span>
                                </p>
                                <p id="insightText" class="text-sm text-slate-600 leading-relaxed font-medium">
                                    Preencha os dados para visualizar a análise.
                                </p>
                            </div>
                            <div id="inflationInsight" class="hidden mt-4 bg-orange-50 border border-orange-100 rounded-xl p-3 flex items-center gap-3">
                                <div class="bg-orange-100 text-orange-600 w-8 h-8 rounded-full flex items-center justify-center text-xs"><i class="fa-solid fa-hourglass-half"></i></div>
                                <div>
                                    <p class="text-[10px] font-bold text-orange-800 uppercase" data-i18n="purchasing_power">Poder de Compra (6m)</p>
                                    <p class="text-xs font-bold text-orange-700" id="txtInflationImpact">--</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Barra Compa-Ratio -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 relative overflow-hidden">
                        <div class="flex justify-between items-end mb-4">
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider" data-i18n="market_pos">Posicionamento de Mercado</p>
                                <h3 class="text-2xl font-bold text-slate-800 mt-1" id="kpiCRA">0%</h3>
                            </div>
                            <span id="kpiCRLabelA" class="text-xs font-bold px-3 py-1 rounded-full bg-slate-50 border border-slate-100 text-slate-500">--</span>
                        </div>
                        
                        <div class="relative h-4 w-full mt-2 select-none">
                            <div class="absolute inset-0 bg-slate-100 rounded-full overflow-hidden flex">
                                <div class="w-[40%] h-full bg-amber-200/50 border-r border-white"></div>
                                <div class="w-[10%] h-full bg-amber-300/50 border-r border-white"></div>
                                <div class="w-[20%] h-full bg-emerald-300/50 border-r border-white"></div>
                                <div class="w-[30%] h-full bg-blue-300/50"></div>
                            </div>
                            <div id="kpiCRPointerA" class="cr-pointer" style="left: 0%;"></div>
                        </div>
                        
                        <div class="relative h-6 w-full mt-1">
                            <div class="scale-marker" style="left: 40%"></div><span class="scale-label" style="left: 40%">80%</span>
                            <div class="scale-marker" style="left: 50%"></div><span class="scale-label" style="left: 50%">100%</span>
                            <div class="scale-marker" style="left: 60%"></div><span class="scale-label" style="left: 60%">120%</span>
                        </div>
                    </div>
                </div>

                <!-- DASHBOARD COMPARATIVO -->
                <div id="comparativeView" class="hidden animate-fade-in space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Col A -->
                        <div class="bg-white rounded-2xl p-5 border-t-4 border-indigo-500 shadow-sm text-center relative">
                            <h4 class="text-xs font-bold text-indigo-700 uppercase mb-3" data-i18n="scenario_a_short">Cenário A</h4>
                            <p class="text-[10px] text-slate-400 uppercase lbl-annual-cost" data-i18n="total_cost_short">Custo Total</p>
                            <p class="text-lg font-extrabold text-slate-800 mb-2" id="compAnnualA">0</p>
                            <div class="bg-indigo-50 inline-block px-3 py-1 rounded-lg mb-2">
                                <span class="text-xs font-bold text-indigo-600" id="compCRA">Comp-Ratio: 0%</span>
                            </div>
                            <div class="relative h-2 w-full mt-2 select-none px-4">
                                <div class="absolute inset-0 mx-4 bg-slate-100 rounded-full overflow-hidden flex h-1.5 mt-1">
                                    <div class="w-[40%] bg-amber-200/50"></div>
                                    <div class="w-[30%] bg-emerald-300/50"></div>
                                    <div class="w-[30%] bg-blue-300/50"></div>
                                </div>
                                <div id="compCRPointerA" class="cr-pointer" style="left: 0%; border-top-color: #4f46e5; transform: translateX(-50%) scale(0.8);"></div>
                            </div>
                        </div>

                        <!-- Delta (Center) -->
                        <div class="flex flex-col justify-center items-center">
                            <div class="bg-white p-3 rounded-full border border-slate-200 text-slate-400 mb-3 shadow-sm">
                                <i class="fa-solid fa-arrow-right text-lg"></i>
                            </div>
                            <div class="w-full bg-white rounded-xl p-4 shadow-sm border border-slate-200 text-center">
                                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1" data-i18n="fin_impact">Impacto Financeiro</p>
                                <p class="text-xl font-extrabold text-slate-800" id="compDeltaVal">0</p>
                            </div>
                        </div>

                        <!-- Col B -->
                        <div class="bg-white rounded-2xl p-5 border-t-4 border-emerald-500 shadow-sm text-center relative">
                            <h4 class="text-xs font-bold text-emerald-700 uppercase mb-3" data-i18n="scenario_b_short">Cenário B</h4>
                            <p class="text-[10px] text-slate-400 uppercase lbl-annual-cost" data-i18n="total_cost_short">Custo Total</p>
                            <p class="text-lg font-extrabold text-slate-800 mb-2" id="compAnnualB">0</p>
                            <div class="bg-emerald-50 inline-block px-3 py-1 rounded-lg mb-2">
                                <span class="text-xs font-bold text-emerald-600" id="compCRB">Comp-Ratio: 0%</span>
                            </div>
                            <div class="relative h-2 w-full mt-2 select-none px-4">
                                <div class="absolute inset-0 mx-4 bg-slate-100 rounded-full overflow-hidden flex h-1.5 mt-1">
                                    <div class="w-[40%] bg-amber-200/50"></div>
                                    <div class="w-[30%] bg-emerald-300/50"></div>
                                    <div class="w-[30%] bg-blue-300/50"></div>
                                </div>
                                <div id="compCRPointerB" class="cr-pointer" style="left: 0%; border-top-color: #10b981; transform: translateX(-50%) scale(0.8);"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Proposal Card -->
                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl shadow-xl p-8 text-white relative overflow-hidden">
                        <div class="absolute right-0 top-0 opacity-10 text-9xl -mr-8 -mt-8"><i class="fa-solid fa-money-bill-wave"></i></div>
                        
                        <div class="relative z-10">
                            <div class="flex items-center gap-2 mb-6 border-b border-slate-600 pb-4">
                                <div class="bg-emerald-500/20 p-1.5 rounded text-emerald-400"><i class="fa-solid fa-hand-holding-dollar"></i></div>
                                <h4 class="text-xs font-bold uppercase tracking-widest text-emerald-400" data-i18n="proposal_title">Proposta de Movimentação</h4>
                            </div>
                            
                            <div class="flex justify-between items-center mb-8">
                                <div>
                                    <p class="text-[10px] text-slate-400 uppercase mb-1 font-bold tracking-wider" data-i18n="curr_salary">Salário Atual (A)</p>
                                    <p class="text-2xl font-bold text-slate-300" id="propSalaryA">0</p>
                                </div>
                                <div class="text-2xl text-slate-600"><i class="fa-solid fa-arrow-right"></i></div>
                                <div class="text-right">
                                    <p class="text-[10px] text-slate-400 uppercase mb-1 font-bold tracking-wider" data-i18n="new_salary">Novo Salário (B)</p>
                                    <p class="text-4xl font-bold text-white tracking-tight" id="propSalaryB">0</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div class="bg-slate-700/50 backdrop-blur-sm rounded-lg px-4 py-2 border border-slate-600 flex items-center gap-4">
                                    <span class="text-xs text-slate-300 uppercase font-semibold" data-i18n="real_increase">Aumento Real</span>
                                    <div class="text-right">
                                        <span class="text-lg font-bold text-emerald-400" id="propIncreaseVal">+ 0</span>
                                        <span class="text-[10px] bg-emerald-500/20 text-emerald-300 px-2 py-0.5 rounded ml-2 font-bold" id="propIncreasePct">+0%</span>
                                    </div>
                                </div>

                                <div id="phasingAlert" class="hidden bg-amber-900/30 border border-amber-500/30 px-4 py-2 rounded-lg flex items-center gap-3 max-w-sm">
                                    <i class="fa-solid fa-triangle-exclamation text-amber-400 text-lg"></i>
                                    <div>
                                        <p class="text-[10px] font-bold text-amber-200 uppercase" data-i18n="alert_phasing">Atenção: Escalonamento</p>
                                        <p class="text-[10px] text-slate-300 leading-tight" data-i18n="alert_desc">Aumento > 30%.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DETALHAMENTO -->
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden animate-fade-in">
                    <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                        <h4 class="text-sm font-bold text-slate-700 uppercase flex items-center gap-2">
                            <i class="fa-solid fa-table-list text-indigo-500"></i> <span data-i18n="fin_detail">Detalhamento Financeiro</span>
                        </h4>
                        <button onclick="exportTableToExcel()" class="text-[10px] font-bold text-emerald-700 bg-white border border-emerald-200 hover:bg-emerald-50 px-3 py-2 rounded-lg transition shadow-sm flex items-center gap-1.5 cursor-pointer">
                            <i class="fa-solid fa-file-excel"></i> <span data-i18n="export_xls">Exportar .XLS</span>
                        </button>
                    </div>
                    
                    <!-- Reference Cards -->
                    <div id="assumptionsCards" class="grid grid-cols-1 md:grid-cols-2 gap-4 px-6 pt-5 pb-2">
                        <!-- Filled by JS -->
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-xs text-left border-collapse" id="costTable">
                            <thead>
                                <!-- JS Generates Headers -->
                            </thead>
                            <tbody class="text-slate-600 divide-y divide-slate-100 font-medium">
                                <!-- Dynamic Rows -->
                            </tbody>
                        </table>
                    </div>

                    <div class="bg-slate-50 p-6 border-t border-slate-200">
                        <h5 class="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-pen-nib"></i> <span data-i18n="exec_summary">Resumo Executivo</span>
                        </h5>
                        <div class="text-sm text-slate-600 leading-relaxed italic space-y-2 border-l-4 border-indigo-400 pl-4" id="detExecutiveSummary">
                            Preencha os dados para gerar o resumo.
                        </div>
                    </div>
                </div>

                <!-- Gráfico -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h4 class="text-sm font-bold text-slate-700 mb-6 uppercase tracking-wide" data-i18n="pkg_composition">Composição do Pacote</h4>
                    <div class="relative h-[300px] w-full">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>

            </div>

            <!-- RODAPÉ FIXO -->
            <footer class="bg-white border-t border-slate-200 py-3 px-8 flex justify-between items-center z-30 text-[10px] text-slate-400 uppercase tracking-wide absolute bottom-0 w-full">
                <span>V22.0 • HR TOOLS</span>
                <div class="flex items-center gap-1">
                    <span>Desenvolvido por</span>
                    <a href="mailto:rh.vinicius@gmail.com" class="font-bold text-indigo-600 hover:text-indigo-800 transition ml-1 flex items-center gap-1">
                        Vinicius Carlos <i class="fa-solid fa-envelope"></i>
                    </a>
                </div>
            </footer>

        </main>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- STATE & CONFIG ---
        const state = { country: 'BR', currency: 'BRL', mode: 'standard', months: 12, dataA: {}, dataB: {} };
        const i18n = {
            BR: { 
                symbol: 'R$', 
                locale: 'pt-BR',
                taxMode: 'Tabela INSS/IRRF 2024',
                chargesHint: 'Estimativa Patronal + SAT',
                concepts: `
                    <h4 class='font-bold text-indigo-600 mb-2'>Conceitos Brasil (CLT) - Modo Preciso</h4>
                    <ul class='list-disc pl-5 space-y-2 text-slate-600'>
                        <li><strong>Salário Líquido:</strong> Calculado utilizando a Tabela Progressiva do INSS (Teto R$ 7.786,02) e Tabela Progressiva do IRRF (Dedução simplificada).</li>
                        <li><strong>Custo Total:</strong> Soma de Salário + Bônus + Encargos + Benefícios.</li>
                        <li><strong>Encargos (~28.8%):</strong> Considera INSS Patronal (20%), SAT (Adjustável) e Sistema S.</li>
                    </ul>
                `,
                ui: {
                    clear: 'Limpar',
                    advanced: 'Avançado',
                    compare_mode: 'Modo Comparativo',
                    concepts_btn: 'Ver Conceitos & Fórmulas',
                    proj_months: 'Projeção (Meses)',
                    advanced_config: 'Configurações Avançadas',
                    charges: 'Encargos (%)',
                    fund: 'Fundo/FGTS (%)',
                    vac_days: 'Dias Férias',
                    fixed_costs: 'Custos Fixos (Mensal)',
                    inflation: 'IPC Mensal Estimado (%)',
                    scenario_a: 'Cenário A (Atual)',
                    scenario_b: 'Cenário B (Proposto)',
                    scenario_a_short: 'Cenário A',
                    scenario_b_short: 'Cenário B',
                    salary: 'Salário Base',
                    bonus_target: 'Bônus Target (Salários)',
                    benefits: 'Benefícios (VA/VR)',
                    net_label: 'Líquido',
                    total_cost_label: 'Custo Total',
                    monthly_avg: 'Média Mensal',
                    fixed_only: '(Apenas Fixo)',
                    impact_analysis: 'Análise de Impacto',
                    purchasing_power: 'Poder de Compra (6m)',
                    market_pos: 'Posicionamento de Mercado',
                    total_cost_short: 'Custo Total',
                    fin_impact: 'Impacto Financeiro',
                    proposal_title: 'Proposta de Movimentação',
                    curr_salary: 'Salário Atual (A)',
                    new_salary: 'Novo Salário (B)',
                    real_increase: 'Aumento Real',
                    alert_phasing: 'Atenção: Escalonamento',
                    alert_desc: 'Aumento > 30%',
                    fin_detail: 'Detalhamento Financeiro',
                    export_xls: 'Exportar .XLS',
                    exec_summary: 'Resumo Executivo',
                    pkg_composition: 'Composição do Pacote',
                    month_a: 'Mês A',
                    year_a: 'Ano A',
                    month_b: 'Mês B',
                    year_b: 'Ano B',
                    month_ref: 'Mensal (Ref)',
                    total_period: 'Total',
                    item: 'Item',
                    delta: 'Delta',
                    sac: '13º Salário',
                    vac: 'Férias (1/3)',
                    var_bonus: 'Bônus',
                    subtotal: 'SUBTOTAL (Colaborador)',
                    charges_row: 'Encargos (Empresa)',
                    grand_total: 'CUSTO TOTAL',
                    assumption_title: 'Premissas de Entrada',
                    base_salary_row: 'Salário Base',
                    target_bonus_row: 'Target Bônus',
                    demonstrative: 'Demonstrativo de Cálculo',
                    invest_text: 'Investimento',
                    comp_invests: 'A empresa investe',
                    perception_text: 'Percepção (Take Home)',
                    comp_perceives: 'O colaborador percebe',
                    comp_rest: 'O resto são impostos/encargos',
                    cost_company: 'Custo Empresa (Delta)',
                    impact_of: 'Impacto de',
                    on_budget: 'no budget',
                    gain_collab: 'Ganho Colaborador',
                    pkg_grows: 'Pacote cresce',
                    health_ph: 'Saúde',
                    dental_ph: 'Odonto',
                    life_ph: 'Vida / Previdência',
                    salary_period: 'Salário (Período)',
                    fixed: 'Salário (Fixo)'
                }
            },
            ARG: { 
                symbol: '$', 
                locale: 'es-AR',
                taxMode: 'Tasa Fija Est. (17%)',
                chargesHint: 'Cargas Sociales + ART (~29%)',
                concepts: `
                    <h4 class='font-bold text-sky-600 mb-2'>Conceptos Argentina (LCT)</h4>
                    <ul class='list-disc pl-5 space-y-2 text-slate-600'>
                        <li><strong>Salario Neto Estimado:</strong> Bruto - 17% (Jubilacion/Ley/Obra Social). No incluye Ganancias (4ta categoría) por complejidad.</li>
                        <li><strong>Inflación (Erosión):</strong> Cálculo de Valor Futuro con tasa IPC constante en 6 meses.</li>
                        <li><strong>Plus Vacacional:</strong> Costo extra generado por el divisor 25 durante vacaciones.</li>
                    </ul>
                `,
                ui: {
                    clear: 'Limpiar',
                    advanced: 'Avanzado',
                    compare_mode: 'Modo Comparativo',
                    concepts_btn: 'Ver Conceptos y Fórmulas',
                    proj_months: 'Proyección (Meses)',
                    advanced_config: 'Configuración Avanzada',
                    charges: 'Cargas Sociales (%)',
                    fund: 'Fondo (%)',
                    vac_days: 'Días Vacaciones',
                    fixed_costs: 'Costos Fijos (Mensual)',
                    inflation: 'IPC Mensual Estimado (%)',
                    scenario_a: 'Escenario A (Actual)',
                    scenario_b: 'Escenario B (Propuesto)',
                    scenario_a_short: 'Escenario A',
                    scenario_b_short: 'Escenario B',
                    salary: 'Salario Base',
                    bonus_target: 'Bonus Target (Salarios)',
                    benefits: 'Beneficios (Comedor/Viáticos)',
                    net_label: 'Neto',
                    total_cost_label: 'Costo Total',
                    monthly_avg: 'Promedio Mensual',
                    fixed_only: '(Solo Fijo)',
                    impact_analysis: 'Análisis de Impacto',
                    purchasing_power: 'Poder Adquisitivo (6m)',
                    market_pos: 'Posicionamiento de Mercado',
                    total_cost_short: 'Costo Total',
                    fin_impact: 'Impacto Financiero',
                    proposal_title: 'Propuesta de Movimiento',
                    curr_salary: 'Salario Actual (A)',
                    new_salary: 'Nuevo Salario (B)',
                    real_increase: 'Aumento Real',
                    alert_phasing: 'Atención: Escalonamiento',
                    alert_desc: 'Aumento > 30%',
                    fin_detail: 'Detalle Financiero',
                    export_xls: 'Exportar .XLS',
                    exec_summary: 'Resumen Ejecutivo',
                    pkg_composition: 'Composición del Paquete',
                    month_a: 'Mes A',
                    year_a: 'Año A',
                    month_b: 'Mes B',
                    year_b: 'Año B',
                    month_ref: 'Mensual (Ref)',
                    total_period: 'Total',
                    item: 'Ítem',
                    delta: 'Delta',
                    sac: 'SAC (Aguinaldo)',
                    vac: 'Plus Vacacional',
                    var_bonus: 'Bonus',
                    subtotal: 'SUBTOTAL (Colaborador)',
                    charges_row: 'Cargas (Empresa)',
                    grand_total: 'COSTO TOTAL',
                    assumption_title: 'Premisas de Entrada',
                    base_salary_row: 'Salario Base',
                    target_bonus_row: 'Target Bonus',
                    demonstrative: 'Demostrativo de Cálculo',
                    invest_text: 'Inversión',
                    comp_invests: 'La empresa invierte',
                    perception_text: 'Percepción (Take Home)',
                    comp_perceives: 'El colaborador percibe',
                    comp_rest: 'El resto son impuestos/cargas',
                    cost_company: 'Costo Empresa (Delta)',
                    impact_of: 'Impacto de',
                    on_budget: 'en budget',
                    gain_collab: 'Ganancia Colaborador',
                    pkg_grows: 'Paquete crece',
                    health_ph: 'Salud',
                    dental_ph: 'Odontología',
                    life_ph: 'Vida',
                    salary_period: 'Salario (Período)',
                    fixed: 'Salario (Fijo)'
                }
            }
        };
        let mainChart = null;

        // --- CORE FUNCTIONS (MOVED UP) ---
        function initChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if(mainChart) mainChart.destroy(); 
            mainChart = new Chart(ctx, { type: 'bar', data: { datasets: [] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } } });
        }

        // --- SAFE DOM HELPERS ---
        function setText(id, val) { const el = document.getElementById(id); if(el) el.innerText = val; }
        function setClass(id, val) { const el = document.getElementById(id); if(el) el.className = val; }
        function setStyle(id, prop, val) { const el = document.getElementById(id); if(el) el.style[prop] = val; }
        function showEl(id, show) { const el = document.getElementById(id); if(el) { if(show) el.classList.remove('hidden'); else el.classList.add('hidden'); } }

        // --- PERSISTENCE ---
        function saveState() {
            const inputs = {};
            document.querySelectorAll('input').forEach(el => {
                if(el.id) inputs[el.id] = el.type === 'checkbox' ? el.checked : el.value;
            });
            inputs.country = state.country;
            localStorage.setItem('vini_comp_calc_v22', JSON.stringify(inputs));
            const ind = document.getElementById('saveIndicator');
            ind.style.opacity = '1';
            setTimeout(() => { ind.style.opacity = '0'; }, 1000);
        }

        function loadState() {
            const saved = localStorage.getItem('vini_comp_calc_v22');
            if (!saved) return false;
            try {
                const inputs = JSON.parse(saved);
                if(inputs.country) selectCountry(inputs.country);
                
                Object.keys(inputs).forEach(key => {
                    const el = document.getElementById(key);
                    if(el) {
                        if(el.type === 'checkbox') {
                            el.checked = inputs[key];
                            if(key === 'compareToggle') {
                                state.mode = el.checked ? 'comparative' : 'standard';
                                toggleModeUI();
                            }
                        } else {
                            el.value = inputs[key];
                        }
                    }
                });
                if(inputs.projMonths) {
                     state.months = parseInt(inputs.projMonths);
                     document.getElementById('projMonthsDisplay').innerText = state.months + " Meses";
                }
                return true;
            } catch(e) { console.error('Load failed', e); return false; }
        }

        function applyTranslations(c) {
            const t = i18n[c].ui;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.innerText = t[key];
            });
            // Update placeholders
            document.getElementById('advHealth').placeholder = t.health_ph;
            document.getElementById('advDental').placeholder = t.dental_ph;
            document.getElementById('advLife').placeholder = t.life_ph;
        }

        // --- INIT ---
        function selectCountry(c) {
            state.country = c; state.currency = c === 'BR' ? 'BRL' : 'ARS';
            const vacInp = document.getElementById('vacationDays');
            const rateCh = document.getElementById('rateCharges');
            const rateFd = document.getElementById('rateFund');
            
            if (c === 'BR') {
                rateCh.value = 28.8; rateFd.value = 8.0; rateFd.parentElement.style.display = 'block';
                vacInp.readOnly = true; vacInp.value = 30;
                document.getElementById('flagDisplay').src = "https://flagcdn.com/w40/br.png";
                showEl('inflationPanel', false);
            } else {
                rateCh.value = 29.0; rateFd.value = 0; rateFd.parentElement.style.display = 'none';
                vacInp.readOnly = false; vacInp.value = 14;
                document.getElementById('flagDisplay').src = "https://flagcdn.com/w40/ar.png";
                showEl('inflationPanel', true);
            }
            
            // apply translations
            applyTranslations(c);

            setText('lblChargesHint', i18n[c].chargesHint);
            setText('taxModeBadgeA', i18n[c].taxMode);
            
            document.getElementById('welcomeModal').style.display = 'none';
            document.getElementById('appContainer').classList.remove('opacity-0');
            document.querySelectorAll('.lbl-curr').forEach(el => el.innerText = i18n[c].symbol);
            
            initChart(); addListeners(); calculateAll();
        }

        function addListeners() {
            document.querySelectorAll('.input-calc, #rateCharges, #vacationDays, #rateFund, #advHealth, #advDental, #advLife, #inflationRate').forEach(i => i.addEventListener('input', () => {
                calculateAll();
                saveState();
            }));
            
            document.querySelectorAll('.fmt-curr').forEach(i => {
                i.addEventListener('input', (e) => {
                    const val = formatCurrencyInput(e.target.value);
                    e.target.value = val;
                    calculateAll();
                    saveState();
                });
            });

            document.getElementById('projMonths').addEventListener('input', (e) => {
                state.months = parseInt(e.target.value);
                const suffix = state.country === 'BR' ? ' Meses' : ' Meses'; 
                document.getElementById('projMonthsDisplay').innerText = state.months + suffix;
                const lbl = i18n[state.country].ui.total_cost_label;
                document.querySelectorAll('.lbl-annual-cost').forEach(el => el.innerText = `${lbl} (${state.months}m)`);
                calculateAll();
                saveState();
            });

            document.getElementById('compareToggle').addEventListener('change', (e) => {
                state.mode = e.target.checked ? 'comparative' : 'standard';
                toggleModeUI(); calculateAll();
                saveState();
            });
        }

        function formatCurrencyInput(value) {
            let num = value.replace(/\D/g, "");
            if (num === "") return "";
            let n = parseFloat(num) / 100;
            return n.toLocaleString(i18n[state.country].locale, { 
                style: 'currency', 
                currency: state.currency 
            });
        }

        function parseVal(id) {
            const el = document.getElementById(id);
            if(!el || !el.value) return 0;
            let raw = el.value.replace(/\D/g, "");
            if(raw === "") return 0;
            return parseFloat(raw) / 100;
        }
        
        // --- TAX LOGIC ---
        function calculateNetBR(gross) {
            if (!gross || gross <= 0) return 0;
            let inss = 0;
            const faixasINSS = [ { limit: 1412.00, rate: 0.075 }, { limit: 2666.68, rate: 0.09 }, { limit: 4000.03, rate: 0.12 }, { limit: 7786.02, rate: 0.14 } ];
            let previousLimit = 0;
            for (let f of faixasINSS) {
                if (gross > previousLimit) {
                    const range = Math.min(gross, f.limit) - previousLimit;
                    inss += range * f.rate;
                    previousLimit = f.limit;
                }
            }
            const baseIRRF = gross - inss;
            let irrf = 0;
            if (baseIRRF <= 2112.00) irrf = 0;
            else if (baseIRRF <= 2826.65) irrf = (baseIRRF * 0.075) - 158.40;
            else if (baseIRRF <= 3751.05) irrf = (baseIRRF * 0.15) - 354.80;
            else if (baseIRRF <= 4664.68) irrf = (baseIRRF * 0.225) - 636.13;
            else irrf = (baseIRRF * 0.275) - 869.36;
            if(irrf < 0) irrf = 0;
            return gross - inss - irrf;
        }

        // --- CALCULATION ---
        function calculateScenario(prefix) {
            const salary = parseVal(`salary${prefix}`);
            const bonusMultiEl = document.getElementById(`bonusMulti${prefix}`);
            const bonusMultiRaw = bonusMultiEl ? parseFloat(bonusMultiEl.value) : 0;
            const flexBen = parseVal(`flexBen${prefix}`);
            const midpoint = parseVal(`midpoint${prefix}`);
            const bonusVal = salary * bonusMultiRaw;
            const db = document.getElementById(`bonusVal${prefix}`);
            if(db) db.value = fmt(bonusVal);

            const chargesPct = parseFloat(document.getElementById('rateCharges').value) / 100;
            const fundPct = parseFloat(document.getElementById('rateFund').value) / 100;
            const vacDays = parseFloat(document.getElementById('vacationDays').value);
            const fixedBen = parseVal('advHealth') + parseVal('advDental') + parseVal('advLife');

            let monthlySalary = salary;
            let monthly13 = 0, monthlyVacPlus = 0, monthlyCharges = 0, monthlyFund = 0, netSalary = 0;

            if (state.country === 'BR') {
                monthly13 = salary / 12; 
                monthlyVacPlus = (salary / 3) / 12;
                const taxBase = salary + monthly13 + monthlyVacPlus + (bonusVal/12);
                monthlyCharges = taxBase * chargesPct; 
                monthlyFund = taxBase * fundPct;
                netSalary = calculateNetBR(salary);
            } else {
                monthly13 = salary / 12; 
                const grossVacPayment = (salary / 25) * vacDays;
                const normalPayment = (salary / 30) * vacDays;
                const annualVacPlus = grossVacPayment - normalPayment;
                monthlyVacPlus = annualVacPlus / 12;
                const taxBase = salary + monthly13 + monthlyVacPlus + (bonusVal/12);
                monthlyCharges = taxBase * chargesPct; 
                monthlyFund = 0;
                netSalary = salary * 0.83; 
            }

            const monthlyBen = flexBen + fixedBen;
            const M = state.months;
            const projSalary = monthlySalary * M;
            const proj13 = monthly13 * M;
            const projVacPlus = monthlyVacPlus * M;
            const projBonus = (bonusVal / 12) * M;
            const projBen = monthlyBen * M;
            const projCharges = (monthlyCharges + monthlyFund) * M;
            const subtotalPackage = projSalary + proj13 + projVacPlus + projBonus + projBen;
            const totalCost = subtotalPackage + projCharges;
            const monthlyAvgCost = totalCost / M;
            const monthlyFixedCash = salary + monthlyBen; 
            const compaRatio = midpoint > 0 ? salary / midpoint : 0;
            const perceptionRatio = totalCost > 0 ? (subtotalPackage / totalCost) * 100 : 0;

            return {
                salary, bonusVal, bonusMulti: bonusMultiRaw, totalCost, monthlyAvgCost, monthlyFixedCash, compaRatio, netSalary,
                projSalary, proj13, projVacPlus, projBonus, projBen, subtotalPackage, projCharges, 
                monthlyBen, perceptionRatio
            };
        }

        function calculateAll() {
            state.dataA = calculateScenario('A');
            if (state.mode === 'comparative') state.dataB = calculateScenario('B');
            updateUI();
        }

        function updateUI() {
            const dA = state.dataA; const dB = state.dataB;
            const t = i18n[state.country].ui;
            
            setText('kpiTotalA', fmt(dA.totalCost));
            setText('kpiMonthlyA', fmt(dA.monthlyFixedCash));
            
            const crPct = Math.round(dA.compaRatio * 100);
            setText('kpiCRA', crPct + '%');
            let pointerLeft = crPct / 2; if(pointerLeft > 100) pointerLeft = 100; if(pointerLeft < 0) pointerLeft = 0;
            setStyle('kpiCRPointerA', 'left', pointerLeft + '%');
            setText('kpiCRLabelA', crPct < 80 ? 'Lagging' : (crPct > 120 ? 'Leading' : 'Match'));

            setText('badgeNetA', t.net_label + ': ' + fmt(dA.netSalary));
            if(state.mode === 'comparative') setText('badgeNetB', t.net_label + ': ' + fmt(dB.netSalary));

            if(state.country === 'ARG' && dA.salary > 0) {
                showEl('inflationInsight', true);
                const rateEl = document.getElementById('inflationRate');
                const rate = rateEl ? parseFloat(rateEl.value) / 100 : 0.05;
                const future = dA.salary / Math.pow(1 + rate, 6);
                const loss = ((1 - (future/dA.salary))*100).toFixed(1);
                setText('txtInflationImpact', `$${fmt(dA.salary)} = ${fmt(future)} (-${loss}%)`);
            } else {
                showEl('inflationInsight', false);
            }

            const perceptionText = `
                <p class="mb-2"><strong><i class="fa-solid fa-coins text-amber-500"></i> ${t.invest_text} (${state.months}m):</strong> ${t.comp_invests} <strong>${fmt(dA.totalCost)}</strong>.</p>
                <p><strong><i class="fa-regular fa-face-smile text-indigo-500"></i> ${t.perception_text}:</strong> ${t.comp_perceives} <strong>${dA.perceptionRatio.toFixed(0)}%</strong>. ${t.comp_rest}.</p>
            `;
            const insightEl = document.getElementById('insightText');
            if(insightEl) insightEl.innerHTML = perceptionText;

            // Assumptions Cards
            const cardContainer = document.getElementById('assumptionsCards');
            let cardsHTML = `
                <div class="bg-indigo-50/50 rounded-lg p-4 border border-indigo-100">
                    <div class="flex items-center gap-2 mb-2 text-indigo-800 font-bold text-xs uppercase tracking-wide">
                        <span class="w-2 h-2 rounded-full bg-indigo-500"></span> ${t.scenario_a}
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-[10px] text-slate-400 font-bold uppercase">${t.base_salary_row}</p>
                            <p class="text-indigo-900 font-bold font-mono text-sm">${fmt(dA.salary)}</p>
                        </div>
                        <div>
                            <p class="text-[10px] text-slate-400 font-bold uppercase">${t.target_bonus_row}</p>
                            <p class="text-indigo-900 font-bold font-mono text-sm">${dA.bonusMulti}x <span class="text-[10px] text-indigo-400">(${fmt(dA.bonusVal)})</span></p>
                        </div>
                    </div>
                </div>
            `;
            
            if (state.mode === 'comparative') {
                const crPctB = Math.round(dB.compaRatio * 100);
                setText('compAnnualA', fmt(dA.totalCost));
                setText('compCRA', 'Comp-Ratio: ' + crPct + '%');
                setText('compAnnualB', fmt(dB.totalCost));
                setText('compCRB', 'Comp-Ratio: ' + crPctB + '%');
                
                let ptrA = crPct / 2; if(ptrA>100)ptrA=100; if(ptrA<0)ptrA=0;
                let ptrB = crPctB / 2; if(ptrB>100)ptrB=100; if(ptrB<0)ptrB=0;
                setStyle('compCRPointerA', 'left', ptrA + '%');
                setStyle('compCRPointerB', 'left', ptrB + '%');

                const delta = dB.totalCost - dA.totalCost;
                setText('compDeltaVal', (delta > 0 ? '+' : '') + fmt(delta));
                setClass('compDeltaVal', delta > 0 ? 'text-xl font-extrabold text-amber-600' : 'text-xl font-extrabold text-emerald-600');

                setText('propSalaryA', fmt(dA.salary));
                setText('propSalaryB', fmt(dB.salary));
                
                const inc = dB.salary - dA.salary;
                const incPct = dA.salary > 0 ? (inc / dA.salary) * 100 : 0;
                setText('propIncreaseVal', (inc > 0 ? '+' : '') + fmt(inc));
                setText('propIncreasePct', (incPct > 0 ? '+' : '') + incPct.toFixed(1) + '%');
                showEl('phasingAlert', incPct > 30);

                const growthPkg = dB.subtotalPackage - dA.subtotalPackage;
                const growthPkgPct = dA.subtotalPackage > 0 ? (growthPkg / dA.subtotalPackage) * 100 : 0;

                let summary = `
                    <p class="mb-2"><i class="fa-solid fa-briefcase text-slate-400"></i> <strong>${t.cost_company}:</strong> ${t.impact_of} <strong>${fmt(delta)}</strong> ${t.on_budget} (${state.months}m).</p>
                    <p class="mb-2"><i class="fa-solid fa-user text-slate-400"></i> <strong>${t.gain_collab}:</strong> ${t.pkg_grows} <strong>${growthPkgPct.toFixed(1)}%</strong>.</p>
                `;
                const sumEl = document.getElementById('detExecutiveSummary');
                if(sumEl) sumEl.innerHTML = summary;

                // Card B
                cardsHTML += `
                    <div class="bg-emerald-50/50 rounded-lg p-4 border border-emerald-100">
                        <div class="flex items-center gap-2 mb-2 text-emerald-800 font-bold text-xs uppercase tracking-wide">
                            <span class="w-2 h-2 rounded-full bg-emerald-500"></span> ${t.scenario_b}
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-[10px] text-slate-400 font-bold uppercase">${t.base_salary_row}</p>
                                <p class="text-emerald-900 font-bold font-mono text-sm">${fmt(dB.salary)}</p>
                            </div>
                            <div>
                                <p class="text-[10px] text-slate-400 font-bold uppercase">${t.target_bonus_row}</p>
                                <p class="text-emerald-900 font-bold font-mono text-sm">${dB.bonusMulti}x <span class="text-[10px] text-emerald-400">(${fmt(dB.bonusVal)})</span></p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                const sumEl = document.getElementById('detExecutiveSummary');
                if(sumEl) sumEl.innerHTML = `<p>Visão detalhada da composição de custos do cenário atual.</p>`;
            }
            cardContainer.innerHTML = cardsHTML;

            renderTable();
            updateChart();
        }

        function renderTable() {
            const tHead = document.querySelector('#costTable thead');
            const tBody = document.querySelector('#costTable tbody');
            const dA = state.dataA; const dB = state.dataB;
            const isComp = state.mode === 'comparative';
            const t = i18n[state.country].ui;
            const periodLabel = `${t.total_period} (${state.months}m)`;

            // Header Construction
            let headerHTML = `<tr class="tr-header-section"><th class="px-6 py-3 border-b border-slate-200 w-1/4">${t.item}</th>`;
            if (isComp) {
                headerHTML += `
                    <th class="px-3 py-3 border-b border-slate-200 text-right text-indigo-400">${t.month_a}</th>
                    <th class="px-3 py-3 border-b border-slate-200 text-right text-indigo-700 font-bold border-r border-slate-200">${t.year_a}</th>
                    <th class="px-3 py-3 border-b border-slate-200 text-right text-emerald-400">${t.month_b}</th>
                    <th class="px-3 py-3 border-b border-slate-200 text-right text-emerald-700 font-bold border-r border-slate-200">${t.year_b}</th>
                    <th class="px-3 py-3 border-b border-slate-200 text-right text-slate-500">${t.delta}</th>
                `;
            } else {
                headerHTML += `
                    <th class="px-4 py-3 border-b border-slate-200 text-right text-indigo-400">${t.month_ref}</th>
                    <th class="px-4 py-3 border-b border-slate-200 text-right text-indigo-700 font-bold">${periodLabel}</th>
                `;
            }
            headerHTML += `</tr>`;
            tHead.innerHTML = headerHTML;

            // Rows
            tBody.innerHTML = '';
            const addRow = (label, valA_Mo, valA_Yr, valB_Mo, valB_Yr) => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50 border-b border-slate-100';
                
                let html = `<td class="px-6 py-3 font-medium text-slate-600">${label}</td>`;
                const fmtCell = (v) => fmt(v);

                if(isComp) {
                    const delta = valB_Yr - valA_Yr;
                    html += `
                        <td class="px-3 py-3 text-right text-slate-400 text-[10px]">${valA_Mo > 0 ? fmtCell(valA_Mo) : '-'}</td>
                        <td class="px-3 py-3 text-right text-indigo-700 font-medium border-r border-slate-100">${valA_Yr > 0 ? fmtCell(valA_Yr) : '-'}</td>
                        <td class="px-3 py-3 text-right text-slate-400 text-[10px]">${valB_Mo > 0 ? fmtCell(valB_Mo) : '-'}</td>
                        <td class="px-3 py-3 text-right text-emerald-700 font-medium border-r border-slate-100">${valB_Yr > 0 ? fmtCell(valB_Yr) : '-'}</td>
                        <td class="px-3 py-3 text-right ${delta>0?'text-amber-600':'text-slate-400'} font-bold">${fmt(delta)}</td>
                    `;
                } else {
                    html += `<td class="px-4 py-3 text-right text-slate-400">${valA_Mo > 0 ? fmtCell(valA_Mo) : '-'}</td><td class="px-4 py-3 text-right text-indigo-800 font-semibold">${valA_Yr > 0 ? fmtCell(valA_Yr) : '-'}</td>`;
                }
                tr.innerHTML = html; tBody.appendChild(tr);
            };

            const addTotalRow = (label, valA, valB) => {
                const tr = document.createElement('tr');
                tr.className = 'tr-total text-xs font-bold text-slate-700';
                
                let html = `<td class="px-6 py-3">${label}</td>`;
                
                if(isComp) {
                    const delta = valB - valA;
                    html += `
                        <td class="px-3 py-3"></td>
                        <td class="px-3 py-3 text-right text-indigo-800 border-r border-slate-200">${fmt(valA)}</td>
                        <td class="px-3 py-3"></td>
                        <td class="px-3 py-3 text-right text-emerald-800 border-r border-slate-200">${fmt(valB)}</td>
                        <td class="px-3 py-3 text-right ${delta>0?'text-amber-600':'text-slate-400'}">${fmt(delta)}</td>
                    `;
                } else {
                    html += `<td class="px-4 py-3"></td><td class="px-4 py-3 text-right text-indigo-900">${fmt(valA)}</td>`;
                }
                tr.innerHTML = html; tBody.appendChild(tr);
            }

            // Calculation Rows
            addRow(t.salary_period, dA.salary, dA.projSalary, dB.salary, dB.projSalary);
            addRow(t.sac, 0, dA.proj13, 0, dB.proj13);
            addRow(t.vac, 0, dA.projVacPlus, 0, dB.projVacPlus);
            addRow(t.var_bonus, 0, dA.projBonus, 0, dB.projBonus);
            addRow(t.benefits, dA.monthlyBen, dA.projBen, dB.monthlyBen, dB.projBen);
            
            // Subtotal
            addTotalRow(t.subtotal, dA.subtotalPackage, dB.subtotalPackage);
            
            // Charges
            addRow(t.charges_row, 0, dA.projCharges, 0, dB.projCharges);
            
            // Grand Total
            const trGrand = document.createElement('tr');
            trGrand.className = 'bg-slate-800 text-white font-bold text-xs';
            let gHtml = `<td class="px-6 py-3">${t.grand_total}</td>`;
            if(isComp) {
                const delta = dB.totalCost - dA.totalCost;
                gHtml += `
                    <td class="px-3 py-3"></td>
                    <td class="px-3 py-3 text-right text-indigo-100 border-r border-slate-600">${fmt(dA.totalCost)}</td>
                    <td class="px-3 py-3"></td>
                    <td class="px-3 py-3 text-right text-emerald-100 border-r border-slate-600">${fmt(dB.totalCost)}</td>
                    <td class="px-3 py-3 text-right text-amber-400">${fmt(delta)}</td>
                `;
            } else {
                gHtml += `<td class="px-4 py-3"></td><td class="px-4 py-3 text-right">${fmt(dA.totalCost)}</td>`;
            }
            trGrand.innerHTML = gHtml; tBody.appendChild(trGrand);
        }

        function toggleAdvanced() {
            const p = document.getElementById('advancedPanel');
            if(p.classList.contains('hidden')) p.classList.remove('hidden'); else p.classList.add('hidden');
        }
        function toggleConcepts(show) {
            const modal = document.getElementById('conceptsModal');
            if (show) {
                const content = document.getElementById('conceptsContent');
                if(content) content.innerHTML = i18n[state.country].concepts;
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }
        function toggleModeUI() {
            const sB = document.getElementById('scenarioB');
            const std = document.getElementById('standardView');
            const comp = document.getElementById('comparativeView');
            if(state.mode === 'comparative') { 
                showEl('scenarioB', true); 
                showEl('standardView', false); 
                showEl('comparativeView', true); 
                if(document.getElementById('midpointB')) document.getElementById('midpointB').value = document.getElementById('midpointA').value; 
            } else { 
                showEl('scenarioB', false); 
                showEl('standardView', true); 
                showEl('comparativeView', false); 
            }
        }
        function resetData() {
            localStorage.removeItem('vini_comp_calc_v22');
            location.reload(); 
        }
        function updateChart() {
            if(!mainChart) return;
            const dA = state.dataA; const dB = state.dataB;
            const t = i18n[state.country].ui;
            const dataA = [dA.projSalary+dA.proj13+dA.projVacPlus, dA.projBonus, dA.projCharges, dA.projBen];
            const ds = [{ label: t.scenario_a_short, data: dataA, backgroundColor: '#6366f1', stack: 'A' }];
            if(state.mode === 'comparative') {
                const dataB = [dB.projSalary+dB.proj13+dB.projVacPlus, dB.projBonus, dB.projCharges, dB.projBen];
                ds.push({ label: t.scenario_b_short, data: dataB, backgroundColor: '#10b981', stack: 'B' });
            }
            mainChart.data.labels = [t.fixed, t.var_bonus, t.charges, t.benefits];
            mainChart.data.datasets = ds;
            mainChart.update();
        }
        function fmt(v) { return (v||0).toLocaleString(i18n[state.country].locale, { style: 'currency', currency: state.currency, minimumFractionDigits: 2 }); }
        
        function exportTableToExcel() {
            const cards = document.getElementById("assumptionsCards").outerHTML;
            const table = document.getElementById("costTable").outerHTML;
            const combinedHTML = `
                <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                <head><meta charset="UTF-8"></head>
                <body>
                    <h3>${i18n[state.country].ui.assumption_title}</h3>
                    ${cards}
                    <br/>
                    <h3>${i18n[state.country].ui.fin_detail}</h3>
                    ${table}
                </body>
                </html>
            `;
            let a = document.createElement("a");
            document.body.appendChild(a);
            const blob = new Blob([combinedHTML], {type: "application/vnd.ms-excel"});
            const url = URL.createObjectURL(blob);
            a.href = url;
            a.download = `Total_Rewards_Vini_${state.country}.xls`;
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        window.onload = function() {
            if(!loadState()) {
                document.getElementById('welcomeModal').style.display = 'flex';
            } else {
                document.getElementById('welcomeModal').style.display = 'none';
                document.getElementById('appContainer').classList.remove('opacity-0');
            }
        };
    </script>
</body>
</html>
